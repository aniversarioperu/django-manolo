
{% extends 'base.html' %}
{% load staticfiles %}
{% load humanize %}

{% block content %}
<style>

.bar {
  fill: steelblue;
}

.bar:hover {
  fill: red;
}

.axis--x path {
  display: none;
}

.toolTip {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: absolute;
        display: none;
        width: auto;
        height: auto;
        background: none repeat scroll 0 0 white;
        border: 0 none;
        border-radius: 8px 8px 8px 8px;
        box-shadow: -3px 3px 15px #888888;
        color: black;
        font: 12px sans-serif;
        padding: 5px;
        text-align: center;
    }

</style>
<div class="container-fluid">
  <div class="row">
    <div class="col-sm-10 col-md-7 col-md-offset-1">

      <h1>Número de visitas de los 500 visitantes más caseritos</h1>
      <svg width="1100" height="500"></svg>
      <div id="bubbles"></div>
      <table class="table table-bordered table-striped">
        <tr>
          <th>Nombre</th>
          <th class="text-center">Cantidad de visitas</th> 
        </tr>
        {% for i in visitors %}

        <tr>
          <td>{{ i.full_name }}</td>
          <td class="text-center">{{ i.number_of_visits|intcomma }} </td> 
        </tr>
        
        {% endfor %}
      </table> 
   
     <!-- bubble graph -->

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
d3.json("/prueba/", function(error, data) {
  if (error) throw error;

  var data_for_circles = {
     "name": "statistics",
     "value": 500,
     "children": [],
  };
 
  for (var i=0; i < data.length; i++) {
     var child = {"name": data[i][0], "value": Math.pow(data[i][1],2), "visitas":data[i][1]}

     data_for_circles["children"].push(child);
  };
 
  //This is making the demensions for the circles and canvas
  //The format and color is for hovering over the circles for the dialog box
  var diameter = 800,
      format = d3.format(",d"),
      color = d3.scale.category20b(); 
 
  //This makes the canvas that the bubble chart will be made on
  var canvas = d3.select("#bubbles").append("svg")
                                .attr("width", diameter)
                                .attr("height", diameter)
                                .append("g")
                                .attr("transform", "translate(0,0)");
 
    //This is the size of the actual bubbles in the chart
    var pack = d3.layout.pack()
                  .size([diameter, diameter])
                  .sort( function(a, b) {
        return -(a.value - b.value);
    })
                  .padding(4);
 
    //This is adding the data into the bubbles and creating their size
         var nodes = pack.nodes(data_for_circles);
         console.log(nodes);
         var node = canvas.selectAll(".node")
                 .data(nodes)
                 .enter()
                 .append("g")
                 .attr("class", "node")
                 .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
 
        //This is the actual bubbles
        node.append("circle")
            .attr("r", function (d) {
               var unit = d.r / 10;
               return d.r;
             })
            .style("fill", function (d, i) { return color(i); })
            
        //This is the text inside the bubbles
        node.append("text")
            .style("text-anchor", "middle")
            .attr("dy", ".1em")
            .text(function (d) { 
              var legend =d.children ? "" : d.name
              return legend.substring(0,10); })
            //this adjust the size of the text to the size of the circle
            .style("font-size", function(d) { 
              return Math.min(2 * d.r, (2 * d.r - 8) / this.getComputedTextLength() * 16) + "px"; })

            .on("mouseover", function(d) {
                d3.select(this).text(function (d) { 
                    return d.children ? "" : d.visitas + " visitas"; })
                  .style("font-weight", "bold")
                }) 
            .on("mouseout", function(d) {
                d3.select(this).text(function (d) { 
                    var legend =d.children ? "" : d.name
                    return legend.substring(0,10); })
                  .style("font-weight","normal")
                });
      // This removes the big circle in the background
      var big_circle = d3.select("circle[r='400']");
      big_circle.remove();
});
                            
</script>
            <!-- bar chart -->


<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
    y = d3.scaleLinear().rangeRound([height, 0]);

var g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//neceario para labels y tooltips
var div = d3.select("body").append("div").attr("class", "toolTip");    
d3.json("/prueba/", function(error, data) {
  if (error) throw error;

  data.forEach(function(d) {
        d.name = d[0];
        d.value = +d[1];
    });

  x.domain(data.map(function(d,i) { return i }));
  y.domain([0, d3.max(data, function(d) { return d.value; })]);

  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10));

  svg.append("text")
    .attr("class", "y label")
    .attr("text-anchor", "end")
    .attr("x", -30)
    .attr("y", 46)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("Número de visitas");  

  g.selectAll(".bar")
    .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d,i) { return x(i); })
      .attr("y", function(d) { return y(d.value); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.value); })
      //neceario para labels y tooltips
      .on("mousemove", function(d){
                div.style("left", d3.event.pageX+10+"px");
                div.style("top", d3.event.pageY-25+"px");
                div.style("display", "inline-block");
                div.html((d.name)+"<br>"+(d.value)+ " visitas");
            })
      .on("mouseout", function(d){
                div.style("display", "none");
            });    
});

</script>


    </div>
  </div><!-- row -->
</div><!-- container -->

{% endblock content %}
